В одном бигтехе, в зеленом финтехе жил да был админ, и админил он большую систему на кубере, а базовые вещи давно руками не делал. Поэтому пусть у нас будет веб-приложение, которе гипотетически зарабатывает бизнесу деньги тем, что пингует заданные адреса. Состит оно из двух (для начала) микросервисов, написано на питоне: flask, немножко requests и js. Пока что stateless.


Часть про написание кода фронта и бэка допишу потом, а сейчас построим пайплайн с помощью GitHub Actions - нам тут главное быстрее выкатиться в прод, стартап мы или где =^_^=


Для начала сделаем так, чтобы при коммите в мастер ветку или пулл реквестах образ пересобирался и пушился в докерхаб регистри.
Пойдем по вот этому гайду: https://docs.docker.com/guides/gha/


Первое, что там надо сделать - это открыть следующий гайд, про Personal Access Tokens:
https://docs.docker.com/security/for-developers/access-tokens/


Логинимся на DockerHub и идем в соответствующий раздел:
https://app.docker.com/settings/personal-access-tokens
где генерим токен и сохраняем его.


Затем добавляем креды в репозиторий: Settings > Security, go to Secrets and variables > Actions.
Создаем repository secret с нашм PAT и variable c логином. Теперь воркер github actions может логиниться в наш регистри и пушить туда собранные образы.


Создаем файл .github/workflows/docker-ci.yml.

Получаем ошибку, потому что по гайду мы работаем в корневом каталоге, а в нашем проекте два сервиса, каждый в своем подкаталоге.
Так что нам надо добавить явное указание поддиректории, поэтому в секции build and push в блоке with добавляем:
context: ./back и сборка работает ^_^ Правда, в докерхабе она кладется в репозитарий my-image, что тоже надо поправить. 
Для начала просто заменим my-image на pngr - образы теперь летят в репозитарий pngr, правда, все равно под неправильным тегом "main".
Пока что заменим pngr на back, останется поменять тег)


Теперь добавим сборку второго образа - фронта. Можно добавить в том же файле, но могут быть проблемы с переменными, а можно добавить еще один action - так пока что будет проще.
Итак, у нас есть два образа на докерхабе, автоматически пересобирающихся по изменениям в репозитории. Время откопать наш кластер!


Да, чатсь про создание кластера через kubeadm тоже будет добавлена, а пока что допустим, что у нас уже есть кластер из двух нод: управляющей и рабочей.


Теперь нам надо:
1) подружить github actions с кластером
2) прописать в deployment'ах ссылки на образы в докерхабе
3) а еще при создании деплойментов должен быть доступ до докерхаба из самого кластера.

Github actions будет ходить в наш кластер с помощью https://github.com/tale/kubectl-action. Для этого нужно взять из кластера kubeconfig: берем с мастерноды /etc/kubernetes/admin.conf.


